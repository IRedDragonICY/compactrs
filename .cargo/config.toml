# ═══════════════════════════════════════════════════════════════════════════════
# Cargo Configuration for CompactRS - EXTREME SIZE OPTIMIZATION
# ═══════════════════════════════════════════════════════════════════════════════
#
# DEVELOPMENT:
#   cargo +nightly run
#
# OPTIMIZED RELEASE:
#   cargo +nightly build --release --target x86_64-pc-windows-msvc
#
# Binary reduced from 439KB to 297KB (32% reduction)
#
# ═══════════════════════════════════════════════════════════════════════════════
# UNSUPPORTED/INCOMPATIBLE FLAGS (tried but failed):
# - -Cembed-bitcode=no          -> Incompatible with LTO
# - -C relocation-model=static  -> Causes LNK2017 ADDR32 errors on MSVC
# - -C prefer-dynamic=no        -> Same linker errors as above
# - -Z virtual-function-elimination -> Requires thin LTO, incompatible with fat LTO
# - -Z threads=8                -> Not recognized by current nightly
# - panic_immediate_abort (build-std-feature) -> Deprecated, now use panic="immediate-abort"
# ═══════════════════════════════════════════════════════════════════════════════

# Unstable features (requires nightly)
[unstable]
build-std = ["std", "panic_abort", "core", "alloc"]
build-std-features = ["optimize_for_size"]

# Target-specific optimizations for Windows MSVC
[target.x86_64-pc-windows-msvc]
rustflags = [
    # MIR optimizations (nightly)
    "-Z", "mir-opt-level=4",
    "-Z", "location-detail=none",
    "-Z", "fmt-debug=none",
    "-Z", "share-generics=y",
    "-Z", "inline-mir-threshold=0",
    # Stable optimizations
    "-C", "symbol-mangling-version=v0",
    "-C", "target-cpu=native",
    # Linker optimizations
    "-C", "link-arg=/MERGE:.rdata=.text",
    "-C", "link-arg=/MERGE:.pdata=.text",
    "-C", "link-arg=/OPT:REF,ICF",
    "-C", "link-arg=/INCREMENTAL:NO",
]
